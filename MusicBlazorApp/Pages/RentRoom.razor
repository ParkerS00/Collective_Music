@page "/rent-a-room"
@using MusicApi.Data;
@using MusicBlazorApp.Data;
@inject IConfiguration config;
@inject HttpClient httpClient;
@inject AuthenticationStateProvider auth;

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap');
</style>

<h1>Rent A Room</h1>

<div div class="main-content">
    <img class="img-fluid img" src="https://dummyimage.com/600x400/000/fff" />
    <div>
        <h1 class="p-5">Rent your own recording studio</h1>
    </div>
</div>

<div class="row mt-5 main-content">

    <h3 class="mt-5">Step One: Select a Room</h3>

    <label for="selectedrm" class="form-label">Select Room</label>
    <p>@SelectedRoomId</p>
    @if (SelectedRoom is not null)
    {
        
    <p>RoomName: @SelectedRoom.RoomName</p>
    }

    <select class="select-element" @bind="SelectedRoomId" >
        @foreach (var rm in Rooms)
        {
            <option value="@rm.Id" @onclick="() => UpdateRoom(rm.Id)">@rm.RoomName</option>
        }
    </select>

    <h3 class="mt-5">Step Two: Select a Date</h3>
    <input type="date"  @onchange="(d) => UpdateDate(DateOnly.Parse(d.Value.ToString()))" />

    <h3 class="mt-5">Step Three: Select Time</h3>
    <label for="starttime">Start Time</label>
    <input type="time" @bind-value="StartTime" id="starttime" />
    <label for="endtime">End Time</label>
    <input type="time" @bind-value="EndTime" id="endtime" />
    <ul>
        @if (SelectedRoom is not null)
        {
            <h1>@SelectedRoom.RoomName</h1>
            @foreach (var timeframe in SelectedRoom.TimeFrames)
            {
                @if (timeframe.isAvailable)
                {
                    <li>@timeframe.startTime to @timeframe.endTime</li>
                }
                else
                {
                    <li style="text-decoration: overline; color: gray;">@timeframe.startTime to @timeframe.endTime</li>

                }
            }
        }
      
    </ul>
</div>

@code {
    //Chosen rental date
    public DateOnly? Date { get; set; } = DateOnly.FromDateTime(DateTime.Now);

    private IEnumerable<RoomDto> Rooms = new List<RoomDto>();

    public TimeOnly StartTime { get; set; }

    public TimeOnly EndTime { get; set; }


    public RoomDto SelectedRoom { get; set; }

    public int SelectedRoomId { get; set; } = 1;

    protected override async Task OnInitializedAsync()
    {
        Rooms = await httpClient.GetFromJsonAsync<IEnumerable<RoomDto>>($"{config[Constants.ApiEndpoint]}/room/{Date?.Month}/{Date?.Day}/{Date?.Year}");

        SelectedRoom = Rooms.Where(r => r.Id == SelectedRoomId).FirstOrDefault();
    }

    private async Task MakeRoomRental()
    {
        var userName = (await auth.GetAuthenticationStateAsync()).User.Identity.Name;
    }

    private void GetAvailableRoomsOnDate(DateTime date)
    {

    }

    private void UpdateRoom (int id)
    {
        SelectedRoomId = id;
        SelectedRoom = Rooms.Where(r => r.Id == SelectedRoomId).FirstOrDefault();

    }

    private async Task UpdateDate(DateOnly date)
    {

        Date = date;
        Rooms = await httpClient.GetFromJsonAsync<IEnumerable<RoomDto>>($"{config[Constants.ApiEndpoint]}/room/{Date?.Month}/{Date?.Day}/{Date?.Year}");
    }
}

